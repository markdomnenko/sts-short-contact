<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lead Form</title>
  
  <!-- Preconnect for faster external resource loading -->
  <link rel="preconnect" href="https://www.google.com">
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://stsrecycling.sugarondemand.com">
  
  <style>
    .ava-form-wide {
      width: 100%;
      max-width: 960px;
      padding: 8px;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      text-align: center;
      margin: 2px auto;
    }
    .ava-form-wide h1 { font-size: 20px; font-weight: 500; margin-bottom: 8px; color: #333; }
    .ava-row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 8px; }
    .ava-col { flex: 1 1 45%; min-width: 200px; }
    .ava-full { flex: 1 1 100%; }
    .ava-col input, .ava-full input {
      width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;
    }
    .g-recaptcha { 
      margin: 0 auto;
      display: inline-block;
    }
    .recaptcha-container {
      text-align: center;
      margin: 15px 0;
    }
    .ava-submit-btn {
      width: 100%; max-width: 200px; padding: 10px; font-size: 14px; font-weight: 500;
      background-color: #0069e1; color: #fff; border: none; border-radius: 6px; cursor: pointer; margin: 15px auto; display: block;
    }
    .ava-submit-btn:hover { background-color: #0057ba; }
    .ava-submit-btn:disabled { 
      background-color: #cccccc; 
      cursor: not-allowed; 
    }
    .ava-hidden { position: absolute; left: -9999px; top: -9999px; pointer-events: none; }
    @media (max-width:600px){
      .ava-col,.ava-full{ flex:1 1 100% }
      .ava-form-wide h1{ font-size:18px }
      .g-recaptcha{ 
        transform:scale(0.88); 
        transform-origin:center center;
      }
    }
  </style>
  
  <!-- Load reCAPTCHA script in head -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
<div style="display:flex; justify-content:center; padding:10px;">
  <div class="ava-form-wide">
    <h1>Free Recycling Quote</h1>

    <form id="WebToLeadForm" action="https://stsrecycling.sugarondemand.com/index.php?entryPoint=WebToLeadCapture" method="POST" name="WebToLeadForm">
      <div class="ava-row">
        <div class="ava-full">
          <input type="text" id="full_name" name="full_name" placeholder="Name*" required />
        </div>
      </div>

      <div class="ava-row">
        <div class="ava-full">
          <input type="text" id="phone_work" name="phone_work" placeholder="Phone Number*" required />
        </div>
      </div>

      <div class="ava-row">
        <div class="ava-full">
          <input type="email" id="email" name="email" placeholder="Email Address*" required />
        </div>
      </div>

      <div class="ava-row">
        <div class="ava-full">
          <input type="text" id="description" name="description" placeholder="Pickup Notes / Request Details" />
        </div>
      </div>

      <!-- reCAPTCHA -->
      <div class="recaptcha-container">
        <div class="g-recaptcha" data-sitekey="6Ld0cZIrAAAAAPgYU8rbR2gOP6FMdB1g-9e5uH1O" data-callback="onRecaptchaValidated" data-expired-callback="onRecaptchaExpired"></div>
        <div id="recaptcha-feedback" style="display:none; color:#c0392b; margin:8px 0; font-size:14px;">Please complete the reCAPTCHA verification.</div>
      </div>

      <!-- Submit Button -->
      <button type="button" class="ava-submit-btn" onclick="submitForm()">Submit</button>

      <!-- Hidden name fields for Sugar (populated from full_name) -->
      <input type="hidden" id="first_name" name="first_name" />
      <input type="hidden" id="last_name" name="last_name" />

      <!-- Tracking -->
      <input type="hidden" id="form_timestamp" name="form_timestamp" />

      <!-- Hidden fields that Sugar needs -->
      <input type="hidden" id="account_name" name="account_name" value="Web Lead" />

      <!-- Honeypots -->
      <div class="ava-hidden">
        <input type="text" id="company_location_fake" name="company_location_fake" autocomplete="off" tabindex="-1" />
        <input type="text" id="sic_code" name="sic_code" autocomplete="off" tabindex="-1" />
        <input type="email" id="confirm_email" name="confirm_email" autocomplete="off" tabindex="-1" />
        <input type="checkbox" id="subscribe_newsletter" name="subscribe_newsletter" tabindex="-1" />

        <!-- All Sugar form fields hidden -->
        <input type="text" id="lead_source_description" name="lead_source_description" autocomplete="off" tabindex="-1" />
        <input type="text" id="account_description" name="account_description" autocomplete="off" tabindex="-1" />
        <input type="text" id="hint_account_description" name="hint_account_description" autocomplete="off" tabindex="-1" />
        <select id="lead_source" name="lead_source" tabindex="-1">
          <option selected="selected" value="Web Site">Web Site</option>
          <option value="Marketing Call">Marketing Call</option>
          <option value="Email Campaign">Email Campaign</option>
          <option value="Trade Show">Trade Show</option>
          <option value="Cold Call">Cold Call</option>
          <option value="Other">Other</option>
          <option value="STS Recycling">STS Recycling</option>
        </select>
      </div>

      <!-- JS token + time trap -->
      <input type="hidden" id="js_token_name" name="js_token_name" />
      <input type="hidden" id="js_token_value" name="js_token_value" />
      <input type="hidden" id="form_rendered_at" name="form_rendered_at" />
      <input type="hidden" id="form_submitted_at" name="form_submitted_at" />

      <!-- SugarCRM - NEW STS MIDWEST CAMPAIGN -->
      <input type="hidden" name="campaign_id" value="0b8cd8d0-8236-11f0-a4c1-3d5acab8b3e9" />
      <input type="hidden" name="redirect_url" value="https://www.stselectronicrecyclinginc.com/thank-you-midwest-2" />
      <input type="hidden" name="redirectRequestType" value="GET" />
      <input type="hidden" name="redirectIncludeParams" value="0" />
      <input type="hidden" name="assigned_user_id" value="c459daee-58d2-42f6-b307-8ad8a8189964" />
      <input type="hidden" name="team_id" value="1" />
      <input type="hidden" name="team_set_id" value="1" />
      <input type="hidden" name="req_id" value="last_name;" />

    </form>
  </div>
</div>

<script src="https://stsrecycling.sugarondemand.com/cache/include/javascript/sugar_grp1.js?v=Q7DTb-dmcWYeZPQO0wBQog"></script>
<script>
  // --- iframe auto-resize: tell parent our height ---
  function sendHeight(){
    const h = 560; // Increased height for pickup notes field
    window.parent && window.parent.postMessage({ type:"setFormHeight", height:h }, "*");
  }
  
  // Call sendHeight after a short delay to ensure reCAPTCHA is rendered
  window.addEventListener("load", function() {
    setTimeout(sendHeight, 500);
  });
  window.addEventListener("resize", sendHeight);

  // --- form protection state ---
  const MIN_SECONDS = 3;
  let formStartTime = Date.now();
  let isCaptchaValidated = false;
  function rand(n){ return Math.random().toString(36).slice(2, 2 + (n||8)); }

  // reCAPTCHA callbacks
  function onRecaptchaValidated(){ 
    isCaptchaValidated = true; 
    document.getElementById('recaptcha-feedback').style.display='none'; 
    console.log('reCAPTCHA validated successfully');
    sendHeight(); 
  }
  function onRecaptchaExpired(){ 
    isCaptchaValidated = false; 
    document.getElementById('recaptcha-feedback').style.display='block'; 
    console.log('reCAPTCHA expired');
    sendHeight(); 
  }

  // Ensure reCAPTCHA loads properly
  window.addEventListener('load', function() {
    setTimeout(function() {
      if (typeof grecaptcha === 'undefined') {
        console.error('reCAPTCHA failed to load - check if domain is authorized');
        document.getElementById('recaptcha-feedback').style.display='block';
        document.getElementById('recaptcha-feedback').textContent = 'Security verification unavailable. Please contact support.';
      } else {
        console.log('reCAPTCHA loaded successfully');
      }
    }, 2000);
  });

  // Sugar's email validation function
  function validateEmailAdd(){
    const emailField = document.getElementById('email');
    if(emailField && emailField.value.length > 0) {
      if(emailField.value.match(/^\w+(['\.\-\+]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,})+$/) == null){
        alert('Not a valid email address');
        return false;
      }
    }
    return true;
  }

  // Split full name into first and last name
  function splitFullName(fullName) {
    const trimmed = fullName.trim();
    const parts = trimmed.split(/\s+/);
    
    if (parts.length === 0) {
      return { firstName: '', lastName: '' };
    } else if (parts.length === 1) {
      return { firstName: parts[0], lastName: parts[0] };
    } else {
      // First word is first name, rest is last name
      const firstName = parts[0];
      const lastName = parts.slice(1).join(' ');
      return { firstName, lastName };
    }
  }

  function submitForm(){
    const form = document.getElementById('WebToLeadForm');

    // Split the full name into first and last
    const fullName = document.getElementById('full_name').value;
    const { firstName, lastName } = splitFullName(fullName);
    document.getElementById('first_name').value = firstName;
    document.getElementById('last_name').value = lastName;

    // honeypots (only check original honeypots, not the Sugar fields)
    const hpHits =
      (document.getElementById('company_location_fake').value || '').trim() !== '' ||
      (document.getElementById('sic_code').value || '').trim() !== '' ||
      (document.getElementById('confirm_email').value || '').trim() !== '' ||
      document.getElementById('subscribe_newsletter').checked;
    if (hpHits) return false;

    // time trap
    const elapsed = (Date.now() - formStartTime) / 1000;
    document.getElementById('form_submitted_at').value = String(Date.now());
    if (elapsed < MIN_SECONDS){ alert('Please take a moment to review your information.'); return false; }

    // email format validation
    const email = document.getElementById('email').value;
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(email)){ alert('Please enter a valid email address.'); return false; }

    // Sugar's field validation (required fields)
    if(!check_webtolead_fields()) return false;

    // captcha
    const recaptchaResponse = (window.grecaptcha && grecaptcha.getResponse()) || '';
    if (!isCaptchaValidated || !recaptchaResponse){
      document.getElementById('recaptcha-feedback').style.display='block';
      alert('Please complete the reCAPTCHA verification before submitting.');
      return false;
    }

    // token
    const tName = document.getElementById('js_token_name').value;
    const tVal = document.getElementById('js_token_value').value;
    if (!tName || !/^[A-Za-z0-9_.-]+$/.test(tVal)) return false;

    // Submit form to parent window
    form.target = "_parent";
    form.submit();
    return true;
  }

  // Sugar's validation function
  function check_webtolead_fields(){
    if(document.getElementById('bool_id') != null){
      var reqs=document.getElementById('bool_id').value;
      bools = reqs.substring(0,reqs.lastIndexOf(';'));
      var bool_fields = bools.split(';');
      nbr_fields = bool_fields.length;
      for(var i=0;i<nbr_fields;i++){
        if(document.getElementById(bool_fields[i]).value == 'on'){
           document.getElementById(bool_fields[i]).value = 1;
        }
        else{
           document.getElementById(bool_fields[i]).value = 0;
        }
      }
    }
    if(document.getElementById('req_id') != null){
      var reqs=document.getElementById('req_id').value;
      reqs = reqs.substring(0,reqs.lastIndexOf(';'));
      var req_fields = reqs.split(';');
      nbr_fields = req_fields.length;
      var req = true;
      for(var i=0;i<nbr_fields;i++){
        if(document.getElementById(req_fields[i]).value.length <= 0 || document.getElementById(req_fields[i]).value == 0){
         req = false;
         break;
        }
      }
      if(req){
        return true;
      }
      else{
        alert('Please provide all the required fields');
        return false;
       }
      return false
    }
    else{
      return true;
    }
  }

  // Initialize form
  document.addEventListener('DOMContentLoaded', function () {
    // Capture referrer and set tracking fields
    const sourceUrl = document.referrer || window.location.href;
    document.getElementById('form_timestamp').value = String(Date.now());
    document.getElementById('form_rendered_at').value = String(formStartTime);

    // Generate simplified security tokens
    const tokenName = 'tok_' + rand(4);
    const tokenVal = rand(8) + Date.now();
    document.getElementById('js_token_name').value = tokenName;
    document.getElementById('js_token_value').value = tokenVal;

    // Auto-populate hidden Sugar fields
    document.getElementById('lead_source_description').value = sourceUrl;
    document.getElementById('account_description').value = "Online Lead";

    sendHeight();
  });
</script>
</body>
</html>
